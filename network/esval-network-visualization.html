<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Esval Massedeponi (Veidekke) Network</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #fcfcfc; font-family: Helvetica, Arial, sans-serif; }
        #network-container { width: 100%; height: 100vh; display: block; position: relative; }
    </style>
</head>
<body>

<div id="network-container">
    <div style="position: absolute; top: 20px; left: 20px; z-index: 100;">
        <h3 style="margin:0; font: bold 14px Helvetica, Arial, sans-serif; color: #111; letter-spacing: 0.5px;">NETTVERK & EIERSTRUKTUR</h3>
        <p style="margin:4px 0 0 0; font: 10px Helvetica, Arial, sans-serif; color: #666;">
            Viser koblinger for: <span style="color:#ff003c; font-weight:bold;">Esval Massedeponi (Veidekke)</span>
        </p>
    </div>

    <div style="position: absolute; bottom: 10px; right: 15px; font: 10px Helvetica, Arial, sans-serif; color: #ccc; pointer-events: none; z-index: 100;">
        Kilde: Brønnøysundregistrene, Skatteetaten
    </div>

    <div style="position: absolute; bottom: 10px; left: 20px; display:flex; flex-wrap:wrap; gap:15px; font:10px Helvetica,Arial,sans-serif; color:#333; z-index:10;">
        <div style="display:flex; align-items:center; gap:6px;">
            <svg width="10" height="10" style="overflow:visible"><rect x="-3" y="-3" width="6" height="6" fill="#111"/></svg> <b>Konsern (ASA)</b>
        </div>
        <div style="display:flex; align-items:center; gap:6px;">
            <svg width="10" height="10" style="overflow:visible"><rect x="-3" y="-3" width="6" height="6" fill="#000EFF"/></svg> Operatør
        </div>
        <div style="display:flex; align-items:center; gap:6px;">
            <svg width="10" height="10" style="overflow:visible"><polygon points="-4,-3 4,-3 0,5" fill="#ff003c"/></svg> Deponi (Aktiv)
        </div>
        <div style="display:flex; align-items:center; gap:6px;">
            <svg width="10" height="10" style="overflow:visible"><rect x="-3" y="-3" width="6" height="6" fill="#e0e0e0" stroke="#999" stroke-width="0.5"/></svg> Datter/Søster
        </div>
    </div>
</div>

<script>
(function(){
    // --- DATA: VEIDEKKE STRUCTURE (USER PROVIDED LIST) ---
    var NODES = [
        // ROOT
        {id:"Veidekke ASA", t:"p"},

        // MAJOR DIVISIONS (TIER 1)
        {id:"Veidekke Entreprenør AS", t:"p", l:"(Owner)"},
        {id:"Veidekke Industri AS", t:"s"},
        {id:"Veidekke Fellestjenester AS", t:"s"},
        {id:"Industrivegen 2 Jessheim AS", t:"s"},
        {id:"Nordre Fokserød Utvikling AS", t:"s"},

        // OPERATOR & ACTIVE SITE
        // Placing Esval under the "Sirkulær" (Circular/Waste) or "Industri" division usually. 
        // Based on typical Veidekke structure, mass handling often falls under Industri or Sirkulær.
        {id:"Veidekke Sirkulær AS", t:"op"},
        {id:"Esval Massedeponi", t:"deponi", active:true},

        // SUBSIDIARIES OF ENTREPRENØR (TIER 2 - Based on user list)
        {id:"Leif Grimsrud AS", t:"s"},
        {id:"Øst AS", t:"s"},
        {id:"Kystmiljø AS", t:"s"},
        {id:"Veidekke Prefab AS", t:"s"},
        {id:"Block Berge Bygg II AS", t:"s"}, // Sub of Prefab usually
        {id:"Båsum Boring AS", t:"s"},
        {id:"Geoenergi AS", t:"s"}, // Sub of Båsum
        {id:"Veihande AS", t:"s"},
        {id:"Hande AS", t:"s"}, // Sub of Veihande
        {id:"Seby AS", t:"s"},
        {id:"Valdresbygg AS", t:"s"}, // Sub of Seby
        {id:"Veidekke Logistikkbygg AS", t:"s"},
        {id:"Rudsflata 11 AS", t:"s"}, // Sub of Logistikkbygg
        {id:"Geo Fundamentering AS", t:"s", l:"(Bergboring)"},
        {id:"Tore Løkke A/S", t:"s"},
        {id:"Grande Entreprenør AS", t:"s"},
        {id:"Rauma Bygg AS", t:"s"},
        {id:"Ttb Eiendom AS", t:"s"},
        {id:"Øst Boligprosjekt AS", t:"s"},
        
        // SUBSIDIARIES OF INDUSTRI
        {id:"Amrock AS", t:"s"},
        {id:"Bergmesteren Raudsand AS", t:"s"}
    ];
    
    // Links: Child -> Parent
    var LINKS = [
        // Level 1: ASA -> Major Divs
        ["Veidekke Entreprenør AS", "Veidekke ASA"],
        ["Veidekke Industri AS", "Veidekke ASA"],
        ["Veidekke Fellestjenester AS", "Veidekke ASA"],
        ["Industrivegen 2 Jessheim AS", "Veidekke ASA"],
        ["Nordre Fokserød Utvikling AS", "Veidekke ASA"],

        // Level 2: Entreprenør Subs
        ["Leif Grimsrud AS", "Veidekke Entreprenør AS"],
        ["Øst AS", "Veidekke Entreprenør AS"],
        ["Kystmiljø AS", "Veidekke Entreprenør AS"],
        ["Veidekke Prefab AS", "Veidekke Entreprenør AS"],
        ["Båsum Boring AS", "Veidekke Entreprenør AS"],
        ["Veihande AS", "Veidekke Entreprenør AS"],
        ["Seby AS", "Veidekke Entreprenør AS"],
        ["Veidekke Logistikkbygg AS", "Veidekke Entreprenør AS"],
        ["Geo Fundamentering AS", "Veidekke Entreprenør AS"],
        ["Tore Løkke A/S", "Veidekke Entreprenør AS"],
        ["Grande Entreprenør AS", "Veidekke Entreprenør AS"],
        ["Rauma Bygg AS", "Veidekke Entreprenør AS"],
        ["Ttb Eiendom AS", "Veidekke Entreprenør AS"],
        ["Øst Boligprosjekt AS", "Veidekke Entreprenør AS"],
        ["Veidekke Sirkulær AS", "Veidekke Entreprenør AS"], // Usually under Entr. or Ind.

        // Level 3: Nested Subs
        ["Block Berge Bygg II AS", "Veidekke Prefab AS"],
        ["Geoenergi AS", "Båsum Boring AS"],
        ["Hande AS", "Veihande AS"],
        ["Valdresbygg AS", "Seby AS"],
        ["Rudsflata 11 AS", "Veidekke Logistikkbygg AS"],

        // Level 2: Industri Subs
        ["Amrock AS", "Veidekke Industri AS"],
        ["Bergmesteren Raudsand AS", "Veidekke Industri AS"],

        // ACTIVE SITE CONNECTION
        // Linking Esval to Sirkulær (Circular/Waste division)
        ["Esval Massedeponi", "Veidekke Sirkulær AS"]
    ];

    var COLORS = {
        p: "#111111", s: "#e0e0e0", op: "#000EFF",      
        deponi: "#ff003c", pukk: "#ff9900", mottak: "#39ff14", gjenvinning: "#39ff14"
    };

    var el = document.getElementById("network-container");
    var W, H, svg, nodes=[], links=[], parentMap={}, childrenMap={};

    function getStrictLineage(startNode) {
        let pathNodes = new Set();
        let pathLinks = new Set();
        pathNodes.add(startNode);
        let curr = startNode;
        while(curr) {
            let parentId = parentMap[curr.id];
            if(!parentId) break;
            let parentNode = nodes.find(n => n.id === parentId);
            if(parentNode) {
                let link = links.find(l => (l.s === curr && l.t === parentNode) || (l.t === curr && l.s === parentNode));
                if(link) pathLinks.add(link);
                pathNodes.add(parentNode);
                curr = parentNode;
            } else break;
        }
        function addChildren(pNode) {
            let kids = childrenMap[pNode.id] || [];
            kids.forEach(kidId => {
                let kNode = nodes.find(n => n.id === kidId);
                if(kNode) {
                    let link = links.find(l => (l.s === kNode && l.t === pNode) || (l.t === kNode && l.s === pNode));
                    if(link) pathLinks.add(link);
                    pathNodes.add(kNode);
                    addChildren(kNode);
                }
            });
        }
        addChildren(startNode);
        return {nodes: pathNodes, links: pathLinks};
    }

    function createShape(type, isActive) {
        var ns = "http://www.w3.org/2000/svg";
        var shape;
        if (type === 'p') { 
            shape = document.createElementNS(ns, "rect");
            shape.setAttribute("x", -5); shape.setAttribute("y", -5);
            shape.setAttribute("width", 10); shape.setAttribute("height", 10);
        } else if (type === 'op') { 
            shape = document.createElementNS(ns, "rect");
            shape.setAttribute("x", -4); shape.setAttribute("y", -4);
            shape.setAttribute("width", 8); shape.setAttribute("height", 8);
        } else if (type === 'deponi') { 
            shape = document.createElementNS(ns, "polygon");
            shape.setAttribute("points", "-4,-3 4,-3 0,4");
        } else if (type === 's') { 
            shape = document.createElementNS(ns, "rect");
            shape.setAttribute("x", -3); shape.setAttribute("y", -3);
            shape.setAttribute("width", 6); shape.setAttribute("height", 6);
        } else { 
            shape = document.createElementNS(ns, "circle");
            shape.setAttribute("r", 3);
        }
        if(isActive) shape.setAttribute("transform", "scale(1.5)");
        return shape;
    }

    function init() {
        if(!el) return;
        LINKS.forEach(pair => {
            let child = pair[0];
            let parent = pair[1];
            parentMap[child] = parent;
            if(!childrenMap[parent]) childrenMap[parent] = [];
            childrenMap[parent].push(child);
        });

        W = el.offsetWidth; H = el.offsetHeight;
        el.innerHTML = "";
        var ns = "http://www.w3.org/2000/svg";
        svg = document.createElementNS(ns, "svg");
        svg.setAttribute("width", "100%");
        svg.setAttribute("height", "100%");
        svg.setAttribute("viewBox", "0 0 " + W + " " + H);
        svg.style.display = "block";
        svg.style.position = "absolute";
        svg.style.top = "0"; svg.style.left = "0"; svg.style.zIndex = "1";
        el.insertBefore(svg, el.firstChild);

        window.addEventListener('resize', function() {
            W = el.offsetWidth; H = el.offsetHeight;
            svg.setAttribute("viewBox", "0 0 " + W + " " + H);
        });

        nodes = NODES.map(d => ({
            id: d.id, type: d.t, label: d.l, active: d.active,
            x: W/2 + (Math.random()-0.5)*100,
            y: H/2 + (Math.random()-0.5)*100,
            vx: 0, vy: 0
        }));

        links = [];
        LINKS.forEach(pair => {
            var s = nodes.find(n=>n.id===pair[0]);
            var t = nodes.find(n=>n.id===pair[1]);
            if(s && t) links.push({s:s, t:t});
        });

        var linkG = document.createElementNS(ns, "g");
        svg.appendChild(linkG);
        links.forEach(l => {
            var line = document.createElementNS(ns, "line");
            line.setAttribute("stroke", "#e5e5e5");
            line.setAttribute("stroke-width", "1");
            linkG.appendChild(line);
            l.el = line;
        });

        var nodeG = document.createElementNS(ns, "g");
        svg.appendChild(nodeG);

        nodes.forEach(n => {
            var g = document.createElementNS(ns, "g");
            g.style.cursor = "pointer";
            
            if (n.active) {
                var ring = document.createElementNS(ns, "circle");
                ring.setAttribute("r", 18);
                ring.setAttribute("fill", "transparent");
                ring.setAttribute("stroke", "#ff003c"); // Red Ring for Deponi
                ring.setAttribute("stroke-width", "1");
                ring.setAttribute("stroke-dasharray", "2,2");
                var anim = document.createElementNS(ns, "animateTransform");
                anim.setAttribute("attributeName", "transform");
                anim.setAttribute("type", "rotate");
                anim.setAttribute("from", "0 0 0");
                anim.setAttribute("to", "360 0 0");
                anim.setAttribute("dur", "10s");
                anim.setAttribute("repeatCount", "indefinite");
                ring.appendChild(anim);
                g.appendChild(ring);
            }

            var hit = document.createElementNS(ns, "circle");
            hit.setAttribute("r", 25); hit.setAttribute("fill", "transparent");
            g.appendChild(hit);

            var shape = createShape(n.type, n.active);
            shape.setAttribute("fill", COLORS[n.type] || "#999");
            if (n.active) { shape.setAttribute("stroke", "#000"); shape.setAttribute("stroke-width", "1.5"); }
            g.appendChild(shape);
            n.shapeEl = shape;

            var txt = document.createElementNS(ns, "text");
            var textContent = n.id;
            if(n.label) textContent += " " + n.label;
            txt.textContent = textContent;
            txt.setAttribute("x", 12); txt.setAttribute("y", 3);
            txt.setAttribute("fill", n.active ? "#000" : "#bbb"); // Grey for non-active subs
            txt.style.font = n.active ? "bold 10px Helvetica, Arial, sans-serif" : "9px Helvetica, Arial, sans-serif"; 
            txt.style.pointerEvents = "none";
            g.appendChild(txt);
            n.tEl = txt;

            g.onmouseenter = function() {
                var lineage = getStrictLineage(n);
                nodes.forEach(node => {
                    node.shapeEl.setAttribute("opacity", "0.1");
                    node.tEl.setAttribute("opacity", "0.1");
                });
                links.forEach(link => {
                    link.el.setAttribute("opacity", "0.1");
                });
                lineage.nodes.forEach(node => {
                    node.shapeEl.setAttribute("opacity", "1");
                    node.tEl.setAttribute("opacity", "1");
                    node.tEl.setAttribute("fill", "#000");
                });
                lineage.links.forEach(link => {
                    link.el.setAttribute("stroke", "#000"); 
                    link.el.setAttribute("opacity", "1");
                });
            };

            g.onmouseleave = function() {
                nodes.forEach(node => {
                    node.shapeEl.setAttribute("opacity", "1");
                    node.tEl.setAttribute("opacity", "1");
                    node.tEl.setAttribute("fill", node.active ? "#000" : "#bbb");
                });
                links.forEach(link => {
                    link.el.setAttribute("stroke", "#e5e5e5");
                    link.el.setAttribute("opacity", "1");
                });
            };

            g.onmousedown = function(e){ e.preventDefault(); n.dragging = true; };
            nodeG.appendChild(g);
            n.el = g;
        });

        window.addEventListener("mousemove", function(e){
            nodes.forEach(n => {
                if(n.dragging) {
                    var rect = svg.getBoundingClientRect();
                    n.x = (e.clientX - rect.left) * (W/rect.width);
                    n.y = (e.clientY - rect.top) * (H/rect.height);
                    n.vx = 0; n.vy = 0;
                }
            });
        });
        window.addEventListener("mouseup", function(){ nodes.forEach(n => n.dragging = false); });

        requestAnimationFrame(tick);
    }

    function tick() {
        links.forEach(l => {
            var dx = l.t.x - l.s.x; var dy = l.t.y - l.s.y;
            var dist = Math.sqrt(dx*dx + dy*dy) || 1;
            var restLen = 60;
            if(l.s.active || l.t.active) restLen = 90;
            var force = (dist - restLen) * 0.05;
            var fx = (dx/dist)*force; var fy = (dy/dist)*force;
            l.s.vx += fx; l.s.vy += fy; l.t.vx -= fx; l.t.vy -= fy;
        });

        nodes.forEach(n => {
            nodes.forEach(n2 => {
                if(n===n2) return;
                var dx = n.x - n2.x; var dy = n.y - n2.y;
                var dist = Math.sqrt(dx*dx + dy*dy) || 1;
                if(dist < 100) { 
                    var f = (100-dist) * 0.05; 
                    n.vx += (dx/dist)*f; n.vy += (dy/dist)*f; 
                }
            });
            n.vx += (W/2 - n.x) * 0.02; 
            n.vy += (H/2 - n.y) * 0.02;
            
            if(!n.dragging) { n.x += n.vx; n.y += n.vy; n.vx *= 0.85; n.vy *= 0.85; }
            n.x = Math.max(20, Math.min(W - 40, n.x));
            n.y = Math.max(20, Math.min(H - 20, n.y));
            if(n.el) n.el.setAttribute("transform", "translate("+n.x+","+n.y+")");
        });

        links.forEach(l => {
            if(l.el) {
                l.el.setAttribute("x1", l.s.x); l.el.setAttribute("y1", l.s.y);
                l.el.setAttribute("x2", l.t.x); l.el.setAttribute("y2", l.t.y);
            }
        });
        if(document.contains(el)) requestAnimationFrame(tick);
    }
    setTimeout(init, 100);
})();
</script>
</body>
</html>
