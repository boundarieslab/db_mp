<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dirty Business Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        #map { width: 100%; height: 100%; }
        
        /* Clean markers */
        .custom-marker { background: transparent !important; border: none !important; }
        
        /* Popup styling */
        .leaflet-popup-content-wrapper {
            border-radius: 0;
            box-shadow: none;
            border: 1px solid #000;
            padding: 0;
        }
        .leaflet-popup-content { margin: 12px 14px; font-family: -apple-system, sans-serif; }
        .leaflet-popup-tip { background: #fff; border: 1px solid #000; border-top: none; border-right: none; box-shadow: none; }
        .popup-name { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
        .popup-type { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: #666; margin-bottom: 4px; }
        .popup-place { font-size: 11px; color: #666; margin-bottom: 10px; }
        .popup-link { display: inline-block; font-size: 11px; color: #000; text-decoration: none; border-bottom: 1px solid #000; }
        .popup-link:hover { opacity: 0.6; }
        
        /* Controls - Bottom Left Stack */
        .leaflet-bottom.leaflet-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .leaflet-control-zoom { 
            border: none !important; 
            box-shadow: none !important; 
            margin-bottom: 5px !important;
        }
        .leaflet-control-zoom a { 
            background: #fff !important; 
            color: #000 !important; 
            border: 1px solid #000 !important; 
            width: 26px !important; 
            height: 26px !important; 
            line-height: 26px !important; 
            border-radius: 0 !important; 
        }
        .leaflet-control-scale { 
            margin-bottom: 10px !important; 
        }
        .leaflet-control-scale-line { 
            border: 1px solid #000 !important; 
            border-top: none !important; 
            background: #fff !important; 
            font-size: 9px !important; 
        }
        .leaflet-tooltip { 
            background: #fff; 
            border: 1px solid #000; 
            border-radius: 0; 
            box-shadow: none; 
            font-size: 11px; 
            padding: 4px 8px; 
        }
        
        /* Layer control styling */
        .leaflet-control-layers {
            border: 1px solid #000 !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }
        .leaflet-control-layers-expanded {
            padding: 8px 12px;
        }
        .leaflet-control-layers-base label,
        .leaflet-control-layers-overlays label {
            font-size: 11px;
            font-family: -apple-system, sans-serif;
        }
        .leaflet-control-layers-separator {
            border-top: 1px solid #ccc;
            margin: 6px 0;
        }
        
        /* North arrow */
        .north-arrow { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            z-index: 1000; 
            background: #fff; 
            border: 1px solid #000; 
            padding: 4px; 
        }
        
        /* Legend - Black symbols only */
        .legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            z-index: 1000;
            background: #fff;
            border: 1px solid #000;
            padding: 10px 14px;
            font-family: -apple-system, sans-serif;
            font-size: 11px;
            min-width: 120px;
        }
        .legend-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend-symbol {
            width: 20px;
            text-align: center;
            margin-right: 8px;
            font-size: 14px;
            color: #000;
        }
        .legend-label {
            color: #333;
        }
    </style>
</head>
<body>

<div id="map"></div>

<div class="north-arrow">
    <svg width="18" height="24" viewBox="0 0 18 24">
        <polygon points="9,0 16,20 9,15 2,20" fill="#000"/>
        <text x="9" y="23" text-anchor="middle" font-size="6" fill="#000">N</text>
    </svg>
</div>

<div class="legend">
    <div class="legend-title">Anleggstype</div>
    <div class="legend-item">
        <span class="legend-symbol">●</span>
        <span class="legend-label">Deponi</span>
    </div>
    <div class="legend-item">
        <span class="legend-symbol">■</span>
        <span class="legend-label">Massemottak</span>
    </div>
    <div class="legend-item">
        <span class="legend-symbol">▲</span>
        <span class="legend-label">Pukkverk</span>
    </div>
    <div class="legend-item">
        <span class="legend-symbol">◆</span>
        <span class="legend-label">Gjenvinning</span>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
// CONFIG
const DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS1KaVHKy2zLYGg4Urbhm2zjZkmuATNvIqJOxuECuU0wdickEExV-8G0vL1F7xG1WKn_ADmwwfSARan/pub?output=csv';
const CARGO_BASE_URL = 'https://dirtybusiness.cargo.site/';

// Marker styles - BLACK symbols
const MARKER_STYLES = {
    'Deponi': { symbol: '●' },
    'Spesialdeponi': { symbol: '●' },
    'Industrideponi': { symbol: '●' },
    'Miljøpark': { symbol: '●' },
    'Massemottak': { symbol: '■' },
    'Massesenter': { symbol: '■' },
    'Pukkverk': { symbol: '▲' },
    'Gjenvinning': { symbol: '◆' },
    'default': { symbol: '●' }
};

// Initialize map
const map = L.map('map', { 
    zoomControl: false,
    center: [60.0, 10.5],
    zoom: 8
});

// ============ BASEMAP LAYERS ============

// Esri World Imagery (Current)
const esriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: '© Esri',
    maxZoom: 19
});

// Geonorge Grayscale (WMS)
const geonorgeGray = L.tileLayer.wms('https://openwms.statkart.no/skwms1/wms.topograatone', {
    layers: 'topograatone',
    format: 'image/png',
    transparent: false,
    attribution: '© Kartverket'
});

// Esri Wayback Historical Imagery
const wayback2023 = L.tileLayer('https://wayback.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/MapServer/tile/48852/{z}/{y}/{x}', {
    attribution: '© Esri Wayback 2023',
    maxZoom: 19
});

const wayback2020 = L.tileLayer('https://wayback.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/MapServer/tile/38892/{z}/{y}/{x}', {
    attribution: '© Esri Wayback 2020',
    maxZoom: 19
});

const wayback2017 = L.tileLayer('https://wayback.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/MapServer/tile/22041/{z}/{y}/{x}', {
    attribution: '© Esri Wayback 2017',
    maxZoom: 19
});

const wayback2014 = L.tileLayer('https://wayback.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/MapServer/tile/10/{z}/{y}/{x}', {
    attribution: '© Esri Wayback 2014',
    maxZoom: 19
});

// OpenStreetMap
const osmStandard = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors',
    maxZoom: 19
});

// Set default basemap
esriImagery.addTo(map);

// ============ WMS OVERLAY LAYERS ============

// Matrikkelkart (property boundaries)
const matrikkelkart = L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.matrikkelkart', {
    layers: 'matrikkelkart',
    format: 'image/png',
    transparent: true,
    attribution: '© Kartverket'
});

// Kommune boundaries
const kommuner = L.tileLayer.wms('https://openwms.statkart.no/skwms1/wms.administrative_enheter', {
    layers: 'Kommunegrense',
    format: 'image/png',
    transparent: true,
    attribution: '© Kartverket'
});

// Fylke boundaries
const fylker = L.tileLayer.wms('https://openwms.statkart.no/skwms1/wms.administrative_enheter', {
    layers: 'Fylkesgrense',
    format: 'image/png',
    transparent: true,
    attribution: '© Kartverket'
});

// ============ CONTROLS ============

// Zoom control
L.control.zoom({ position: 'bottomleft' }).addTo(map);

// Scale bar
L.control.scale({ 
    position: 'bottomleft', 
    metric: true, 
    imperial: false, 
    maxWidth: 120 
}).addTo(map);

// Layer groups
const markersLayer = L.layerGroup().addTo(map);
const polygonsLayer = L.layerGroup(); // For future polygon data

// Layer control
const baseMaps = {
    "Esri Satellite": esriImagery,
    "Esri 2023": wayback2023,
    "Esri 2020": wayback2020,
    "Esri 2017": wayback2017,
    "Esri 2014": wayback2014,
    "Gråtone": geonorgeGray,
    "OpenStreetMap": osmStandard
};

const overlayMaps = {
    "Anlegg": markersLayer,
    "Områder": polygonsLayer,
    "Matrikkelkart": matrikkelkart,
    "Kommunegrenser": kommuner,
    "Fylkesgrenser": fylker
};

L.control.layers(baseMaps, overlayMaps, { 
    position: 'topright',
    collapsed: true 
}).addTo(map);

// ============ DATA LOADING ============

function createSlug(name) {
    return name.toLowerCase()
        .replace(/æ/g, 'ae').replace(/ø/g, 'o').replace(/å/g, 'a')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '');
}

Papa.parse(DATA_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
        console.log('CSV loaded, rows:', results.data.length);
        console.log('Headers:', results.meta.fields);
        console.log('First row:', results.data[0]);
        
        results.data.forEach((site, index) => {
            // Helper to parse numbers with comma or dot as decimal separator
            function parseCoord(val) {
                if (!val) return NaN;
                // Replace comma with dot for European format
                return parseFloat(String(val).replace(',', '.'));
            }
            
            // Try different possible column names
            const lat = parseCoord(site.Latitude || site.latitude || site.Lat || site.lat || site.Y || site.y);
            const lon = parseCoord(site.Longitude || site.longitude || site.Lon || site.lon || site.Long || site.long || site.X || site.x);
            
            if (isNaN(lat) || isNaN(lon)) {
                console.log('Invalid coordinates for row', index, site);
                return;
            }
            
            const type = site.Type || site.type || site.TYPE || 'default';
            const name = site.Name || site.name || site.NAME || site.Navn || site.navn || 'Unknown';
            const municipality = site.Municipality || site.municipality || site.Kommune || site.kommune || '';
            const county = site.County || site.county || site.Fylke || site.fylke || '';
            
            const style = MARKER_STYLES[type] || MARKER_STYLES['default'];
            const slug = createSlug(name);
            
            const icon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="color:#000;font-size:16px;line-height:1;">${style.symbol}</div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });
            
            const place = [municipality, county].filter(p => p).join(', ');
            
            const popupContent = `
                <div class="popup-name">${name}</div>
                <div class="popup-type">${type}</div>
                <div class="popup-place">${place}</div>
                <a href="${CARGO_BASE_URL}${slug}" target="_top" class="popup-link">View details →</a>
            `;
            
            L.marker([lat, lon], { icon })
                .addTo(markersLayer)
                .bindPopup(popupContent, { closeButton: false })
                .bindTooltip(name, { direction: 'top', offset: [0, -8] });
        });
        
        console.log('Markers added:', markersLayer.getLayers().length);
    },
    error: function(error) {
        console.error('Error loading CSV:', error);
    }
});

// ============ POLYGON LOADING (example) ============
// To add polygons from a GeoJSON URL or file:
// 
// fetch('https://your-geojson-url.json')
//     .then(response => response.json())
//     .then(data => {
//         L.geoJSON(data, {
//             style: {
//                 color: '#000',
//                 weight: 1,
//                 fillOpacity: 0.2
//             },
//             onEachFeature: function(feature, layer) {
//                 if (feature.properties && feature.properties.name) {
//                     layer.bindPopup(feature.properties.name);
//                 }
//             }
//         }).addTo(polygonsLayer);
//     });

</script>
</body>
</html>
