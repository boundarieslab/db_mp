<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dirty Business Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* --- RESET --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; }
        
        #map { width: 100%; height: 100%; background: #e0e0e0; }
        
        /* --- MARKERS --- */
        .dot-marker {
            background-color: #000;
            border: 2px solid #fff;
            border-radius: 50%;
            box-shadow: 0 1px 4px rgba(0,0,0,0.4);
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .dot-marker:hover {
            transform: scale(1.3);
            border-color: #000;
            background-color: #fff; 
            z-index: 1000 !important;
        }

        /* --- CONTROLS --- */
        .leaflet-control-zoom { 
            border: none !important; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2) !important; 
            margin-left: 20px !important; 
            margin-bottom: 30px !important; 
        }
        .leaflet-control-zoom a { 
            background: #fff !important; 
            color: #000 !important; 
            border-radius: 0 !important; 
            width: 32px !important; 
            height: 32px !important; 
            line-height: 32px !important; 
            font-size: 14px !important;
            border: 1px solid #ccc !important;
        }
        .leaflet-control-zoom a:hover { background: #f4f4f4 !important; }
        
        .leaflet-control-layers { 
            border: none !important; 
            border-radius: 0 !important; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important; 
            font-size: 12px; 
            font-family: inherit;
        }
        .leaflet-control-layers-toggle { width: 40px; height: 40px; background-size: 24px; }
        .leaflet-control-layers-expanded { padding: 15px; background: #fff; border-radius: 2px; }

        /* --- CONTROLS CONTAINER (Top Left) --- */
        .top-left-container {
            position: absolute;
            top: 20px; left: 20px; z-index: 1000;
            display: flex; align-items: center; gap: 15px;
        }

        .north-arrow {
            background: #fff; padding: 8px 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 1px solid #ccc;
        }

        .lang-switch {
            display: flex; background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 1px solid #ccc; cursor: pointer;
        }
        .lang-btn {
            padding: 8px 12px; font-size: 12px; font-weight: 700;
            transition: background 0.2s, color 0.2s;
        }
        .lang-btn.active { background: #000; color: #fff; }
        .lang-btn:hover:not(.active) { background: #f0f0f0; }

        /* --- POPUP --- */
        .leaflet-popup-content-wrapper { border-radius: 0; padding: 0; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .leaflet-popup-content { margin: 0; min-width: 240px; }
        .leaflet-popup-tip { display: none; }
        
        .popup-box { padding: 20px; background: #fff; }
        .popup-header { font-size: 16px; font-weight: 700; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .popup-meta { font-size: 12px; color: #555; line-height: 1.5; margin-bottom: 15px; }
        .popup-btn {
            display: block; width: 100%; background: #000; color: #fff;
            text-align: center; padding: 10px 0; font-size: 11px; font-weight: 700;
            text-decoration: none; text-transform: uppercase; letter-spacing: 0.5px;
            transition: opacity 0.2s;
        }
        .popup-btn:hover { opacity: 0.8; }
        .leaflet-container a.leaflet-popup-close-button { top: 5px; right: 5px; color: #999; font-size: 18px; }

        /* --- LEGEND --- */
        .legend {
            position: absolute; bottom: 30px; right: 20px; z-index: 900;
            background: #fff; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-width: 160px;
        }
        .legend-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
        .legend-item { display: flex; align-items: center; font-size: 12px; margin-bottom: 5px; }
        .legend-dot { width: 12px; height: 12px; background: #000; border-radius: 50%; margin-right: 10px; border: 2px solid #fff; box-shadow: 0 0 2px rgba(0,0,0,0.3); }

    </style>
</head>
<body>

<div id="map"></div>

<div class="top-left-container">
    <div class="north-arrow">
        <svg width="14" height="20" viewBox="0 0 18 24">
            <polygon points="9,0 16,20 9,15 2,20" fill="#000"/>
        </svg>
    </div>
    <div class="lang-switch">
        <div class="lang-btn active" onclick="setLang('NO')">NO</div>
        <div class="lang-btn" onclick="setLang('EN')">EN</div>
    </div>
</div>

<div class="legend">
    <div class="legend-title" data-i18n="legend_title">Tegnforklaring</div>
    <div class="legend-item">
        <div class="legend-dot"></div>
        <span data-i18n="legend_item">Avfallsanlegg</span>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
const DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS1KaVHKy2zLYGg4Urbhm2zjZkmuATNvIqJOxuECuU0wdickEExV-8G0vL1F7xG1WKn_ADmwwfSARan/pub?output=csv';
const CARGO_BASE_URL = 'https://dirtybusiness.cargo.site/';

const TRANSLATIONS = {
    'NO': {
        legend_title: 'Tegnforklaring',
        legend_item: 'Avfallsanlegg',
        view_details: 'VIS DETALJER →',
        type_default: 'Anlegg',
        // Layer Names
        layers_sat: 'Satellitt',
        layers_orto: 'Ortofoto (NiB)',
        layers_gray: 'Norge Gråtone',
        layers_sediment: 'Løsmasser (Jordarter)',
        layers_gravel: 'Grus og Pukk',
        layers_nin: 'Landskap (NiN)',
        layers_muni: 'Kommunegrenser',
        layers_county: 'Fylkesgrenser'
    },
    'EN': {
        legend_title: 'Legend',
        legend_item: 'Waste Facility',
        view_details: 'VIEW DETAILS →',
        type_default: 'Facility',
        // Layer Names
        layers_sat: 'Satellite',
        layers_orto: 'Orthophoto (NiB)',
        layers_gray: 'Norway Grey',
        layers_sediment: 'Sediments (Soil Types)',
        layers_gravel: 'Gravel & Aggregates',
        layers_nin: 'Landscape (NiN)',
        layers_muni: 'Municipalities',
        layers_county: 'Counties'
    }
};

let currentLang = 'NO';
let loadedSites = [];

const map = L.map('map', { 
    zoomControl: false, 
    center: [59.91, 10.75], // Oslo
    zoom: 9 
});

// --- BASE LAYERS ---

// 1. Esri Satellite
const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Esri', maxZoom: 19
});

// 2. Norge i Bilder (Ortofoto) - Verified
const nibOrto = L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.nib?', {
    layers: 'ortofoto',
    format: 'image/png',
    transparent: false,
    attribution: 'Geonorge'
});

// 3. Norge Gråtone (Correct: topo4graatone)
const geonorgeGray = L.tileLayer.wms('https://openwms.statkart.no/skwms1/wms.topo4graatone', {
    layers: 'topo4graatone_WMS',
    format: 'image/png',
    transparent: false,
    attribution: 'Kartverket'
});

// --- OVERLAY LAYERS ---

// 4. Løsmasser (Sediments) - NGU Verified
const losmasser = L.tileLayer.wms('https://geo.ngu.no/mapserver/LosmasserWMS2?', {
    layers: 'Jordarter',
    format: 'image/png',
    transparent: true,
    opacity: 0.6,
    attribution: 'NGU'
});

// 5. Grus og Pukk - NGU Verified (From your Atom Link)
const grusPukk = L.tileLayer.wms('https://geo.ngu.no/mapserver/GrusOgPukkWMS2?', {
    layers: 'Forekomst',
    format: 'image/png',
    transparent: true,
    opacity: 0.7,
    attribution: 'NGU'
});

// 6. NiN Landskap - Artsdatabanken Verified
const ninLandskap = L.tileLayer.wms('https://wms.artsdatabanken.no/?map=/maps/mapfiles/la.map', {
    layers: 'LA',
    format: 'image/png',
    transparent: true,
    opacity: 0.6,
    attribution: 'Artsdatabanken'
});

// 7. Borders
const kommuner = L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.adm_enheter', {
    layers: 'Kommunegrense',
    format: 'image/png',
    transparent: true,
    attribution: 'Kartverket'
});

const fylker = L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.adm_enheter', {
    layers: 'Fylkesgrense',
    format: 'image/png',
    transparent: true,
    attribution: 'Kartverket'
});

esriSat.addTo(map); // Default

// Controls
L.control.zoom({ position: 'bottomleft' }).addTo(map);
L.control.scale({ position: 'bottomleft', metric: true, imperial: false }).addTo(map);

// Layer Control Setup
const baseMaps = {
    "<span data-i18n='layers_sat'>Satellitt</span>": esriSat,
    "<span data-i18n='layers_orto'>Ortofoto (NiB)</span>": nibOrto,
    "<span data-i18n='layers_gray'>Norge Gråtone</span>": geonorgeGray
};

const overlayMaps = {
    "<span data-i18n='layers_sediment'>Løsmasser</span>": losmasser,
    "<span data-i18n='layers_gravel'>Grus og Pukk</span>": grusPukk,
    "<span data-i18n='layers_nin'>Landskap (NiN)</span>": ninLandskap,
    "<span data-i18n='layers_muni'>Kommunegrenser</span>": kommuner,
    "<span data-i18n='layers_county'>Fylkesgrenser</span>": fylker
};

L.control.layers(baseMaps, overlayMaps, { position: 'topright', collapsed: true }).addTo(map);

// --- MARKERS ---
const markersLayer = L.layerGroup().addTo(map);

function createSlug(name) {
    return name.toLowerCase()
        .replace(/æ/g, 'ae').replace(/ø/g, 'o').replace(/å/g, 'a')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '');
}

function updatePopups() {
    markersLayer.eachLayer(marker => {
        const site = marker.siteData;
        const t = TRANSLATIONS[currentLang];
        const name = site.Name || site.name || 'Unknown';
        const type = site.Type || site.type || t.type_default;
        const muni = site.Municipality || site.municipality || '';
        const place = [muni].filter(x => x).join(', ');
        const slug = createSlug(name);

        const content = `
            <div class="popup-box">
                <div class="popup-header">${name}</div>
                <div class="popup-meta">${type}<br>${place}</div>
                <a href="${CARGO_BASE_URL}${slug}" target="_top" class="popup-btn">${t.view_details}</a>
            </div>
        `;
        marker.setPopupContent(content);
    });

    // Update UI Texts
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (TRANSLATIONS[currentLang][key]) {
            el.innerHTML = TRANSLATIONS[currentLang][key];
        }
    });
}

function setLang(lang) {
    currentLang = lang;
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.innerText === lang);
    });
    updatePopups();
}

Papa.parse(DATA_URL, {
    download: true, header: true, skipEmptyLines: true,
    complete: function(results) {
        results.data.forEach((site) => {
            const lat = parseFloat((site.Latitude || site.lat || '').replace(',', '.'));
            const lon = parseFloat((site.Longitude || site.lon || '').replace(',', '.'));

            if (isNaN(lat) || isNaN(lon)) return;

            const icon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="dot-marker" style="width: 12px; height: 12px;"></div>`,
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });

            const marker = L.marker([lat, lon], { icon: icon });
            marker.siteData = site;
            marker.bindPopup("Loading...", { maxWidth: 300 });
            marker.bindTooltip(site.Name, { direction: 'top', offset: [0, -8] });
            
            marker.on('click', function() {
                map.flyTo([lat, lon], 16, { duration: 1.5 });
            });

            markersLayer.addLayer(marker);
        });
        updatePopups();
    }
});
</script>
</body>
</html>
