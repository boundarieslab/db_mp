<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dirty Business Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* --- GLOBAL RESET --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        #map { width: 100%; height: 100%; background: #e0e0e0; }
        
        /* --- CUSTOM ICONS (Minimalist Dots) --- */
        .dot-marker {
            background-color: #000;
            border: 2px solid #fff;
            border-radius: 50%;
            box-shadow: 0 1px 4px rgba(0,0,0,0.4);
            transition: transform 0.2s ease;
        }
        .dot-marker:hover {
            transform: scale(1.3);
            border-color: #ffe600; /* Yellow highlight on hover */
            z-index: 1000 !important;
        }

        /* --- CONTROLS STYLING --- */
        .leaflet-control-zoom { border: 1px solid #000 !important; box-shadow: none !important; margin-left: 10px !important; margin-bottom: 10px !important; }
        .leaflet-control-zoom a { background: #fff !important; color: #000 !important; border-radius: 0 !important; width: 30px !important; height: 30px !important; line-height: 30px !important; }
        .leaflet-control-zoom a:hover { background: #f0f0f0 !important; }
        
        .leaflet-control-layers { border: 1px solid #000 !important; border-radius: 0 !important; box-shadow: none !important; font-size: 11px; }
        .leaflet-control-layers-toggle { width: 30px; height: 30px; background-size: 20px; }
        
        .leaflet-tooltip { 
            background: #000; 
            color: #fff; 
            border: none; 
            border-radius: 0; 
            font-size: 11px; 
            padding: 4px 8px; 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
        }
        .leaflet-tooltip-top:before { border-top-color: #000; }

        /* --- LANGUAGE TOGGLE (Top Right) --- */
        .lang-switch {
            position: absolute;
            top: 10px;
            right: 50px; /* Left of the layers button */
            z-index: 1000;
            background: #fff;
            border: 1px solid #000;
            display: flex;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
        }
        .lang-btn {
            padding: 6px 10px;
            transition: background 0.2s;
        }
        .lang-btn.active {
            background: #000;
            color: #fff;
        }
        
        /* --- LEGEND --- */
        .legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            z-index: 900;
            background: #fff;
            border: 1px solid #000;
            padding: 12px 16px;
            min-width: 140px;
        }
        .legend-title { font-weight: 700; margin-bottom: 8px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 6px; }
        .legend-dot { width: 10px; height: 10px; background: #000; border-radius: 50%; margin-right: 10px; border: 1px solid #000; }
        /* Variations for legend if we wanted types, but sticking to black for uniform look */
        .legend-label { font-size: 12px; color: #333; }

        /* --- POPUP --- */
        .leaflet-popup-content-wrapper { border-radius: 0; padding: 0; border: 1px solid #000; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .leaflet-popup-content { margin: 15px; font-family: inherit; min-width: 200px; }
        .leaflet-popup-tip { border: 1px solid #000; border-top: none; border-right: none; }
        .popup-header { border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 8px; }
        .popup-name { font-size: 15px; font-weight: 700; color: #000; }
        .popup-meta { font-size: 11px; color: #666; margin-bottom: 12px; line-height: 1.4; }
        .popup-link { 
            display: inline-block; 
            background: #000; 
            color: #fff; 
            text-decoration: none; 
            font-size: 11px; 
            padding: 6px 12px; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            transition: opacity 0.2s;
        }
        .popup-link:hover { opacity: 0.8; }

        /* --- NORTH ARROW --- */
        .north-arrow { position: absolute; top: 10px; left: 10px; z-index: 900; background: #fff; border: 1px solid #000; padding: 6px; }

    </style>
</head>
<body>

<div id="map"></div>

<div class="north-arrow">
    <svg width="14" height="20" viewBox="0 0 18 24">
        <polygon points="9,0 16,20 9,15 2,20" fill="#000"/>
    </svg>
</div>

<div class="lang-switch">
    <div class="lang-btn active" onclick="setLang('NO')">NO</div>
    <div class="lang-btn" onclick="setLang('EN')">EN</div>
</div>

<div class="legend" id="legendBox">
    <div class="legend-title" data-i18n="legend_title">Anleggstype</div>
    <div class="legend-item">
        <div class="legend-dot"></div>
        <span class="legend-label" data-i18n="legend_item">Registrert anlegg</span>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
// --- CONFIGURATION ---
const DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS1KaVHKy2zLYGg4Urbhm2zjZkmuATNvIqJOxuECuU0wdickEExV-8G0vL1F7xG1WKn_ADmwwfSARan/pub?output=csv';
const CARGO_BASE_URL = 'https://dirtybusiness.cargo.site/';

// --- TRANSLATIONS ---
const TRANSLATIONS = {
    'NO': {
        legend_title: 'Kartlag',
        legend_item: 'Avfallsanlegg',
        view_details: 'Les mer →',
        type_default: 'Anlegg'
    },
    'EN': {
        legend_title: 'Map Layers',
        legend_item: 'Waste Facility',
        view_details: 'View Details →',
        type_default: 'Facility'
    }
};

let currentLang = 'NO'; // Default language

// --- MAP SETUP ---
const map = L.map('map', { 
    zoomControl: false, // We add it manually to style it
    center: [65.0, 14.0], // Zoomed out to see Norway
    zoom: 5
});

// --- LAYERS ---

// 1. Esri Satellite (Base)
const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Esri', maxZoom: 19
});

// 2. Geonorge Gråtone (The "Real" WMS for Grey Map)
// Updated to standard 'topograatone' layer
const geonorgeGray = L.tileLayer.wms('https://openwms.statkart.no/skwms1/wms.topograatone', {
    layers: 'topograatone',
    format: 'image/png',
    transparent: false,
    attribution: 'Kartverket'
});

// 3. Historical Layers (Wayback)
// Using confirmed IDs. If these fail in future, standard Satellite remains.
const wayback2023 = L.tileLayer('https://wayback.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/MapServer/tile/44629/{z}/{y}/{x}', { attribution: 'Esri 2023' });
const wayback2020 = L.tileLayer('https://wayback.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/MapServer/tile/9337/{z}/{y}/{x}', { attribution: 'Esri 2020' });
const wayback2017 = L.tileLayer('https://wayback.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/MapServer/tile/5970/{z}/{y}/{x}', { attribution: 'Esri 2017' });
const wayback2014 = L.tileLayer('https://wayback.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/MapServer/tile/2635/{z}/{y}/{x}', { attribution: 'Esri 2014' });

// 4. Overlays (Borders)
// Geonorge updated layer names: "Kommuner" and "Fylker" (not Kommunegrense)
const kommuner = L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.adm_enheter', {
    layers: 'Kommuner',
    format: 'image/png',
    transparent: true,
    opacity: 0.7,
    attribution: 'Kartverket'
});

const fylker = L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.adm_enheter', {
    layers: 'Fylker',
    format: 'image/png',
    transparent: true,
    opacity: 0.9,
    attribution: 'Kartverket'
});

const matrikkel = L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.matrikkelkart', {
    layers: 'matrikkelkart',
    format: 'image/png',
    transparent: true,
    attribution: 'Kartverket'
});

// Default Layer
esriSat.addTo(map);

// Controls
L.control.zoom({ position: 'bottomleft' }).addTo(map);
L.control.scale({ position: 'bottomleft', metric: true, imperial: false }).addTo(map);

const baseMaps = {
    "Satellite (Latest)": esriSat,
    "Norge Gråtone": geonorgeGray,
    "Sat 2023": wayback2023,
    "Sat 2020": wayback2020,
    "Sat 2017": wayback2017,
    "Sat 2014": wayback2014
};

const overlayMaps = {
    "Kommuner": kommuner,
    "Fylker": fylker,
    "Eiendom (Matrikkel)": matrikkel
};

L.control.layers(baseMaps, overlayMaps, { position: 'topright', collapsed: true }).addTo(map);

// --- MARKERS & DATA ---

const markersLayer = L.layerGroup().addTo(map);

function createSlug(name) {
    return name.toLowerCase()
        .replace(/æ/g, 'ae').replace(/ø/g, 'o').replace(/å/g, 'a')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '');
}

// Store data globally to allow language switching
let loadedSites = [];

function updatePopups() {
    markersLayer.eachLayer(marker => {
        const site = marker.siteData;
        const t = TRANSLATIONS[currentLang];
        
        // Popup Content
        const name = site.Name || site.name || 'Unknown';
        const type = site.Type || site.type || t.type_default;
        const muni = site.Municipality || site.municipality || '';
        const county = site.County || site.county || '';
        const place = [muni, county].filter(x => x).join(', ');
        const slug = createSlug(name);

        const content = `
            <div class="popup-header">
                <div class="popup-name">${name}</div>
            </div>
            <div class="popup-meta">
                ${type}<br>
                ${place}
            </div>
            <a href="${CARGO_BASE_URL}${slug}" target="_top" class="popup-link">${t.view_details}</a>
        `;
        
        marker.setPopupContent(content);
    });
    
    // Update Interface Text
    document.querySelector('[data-i18n="legend_title"]').innerText = TRANSLATIONS[currentLang].legend_title;
    document.querySelector('[data-i18n="legend_item"]').innerText = TRANSLATIONS[currentLang].legend_item;
}

function setLang(lang) {
    currentLang = lang;
    
    // Toggle active button class
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.innerText === lang);
    });

    updatePopups();
}

// Load Data
Papa.parse(DATA_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
        
        results.data.forEach((site) => {
            const lat = parseFloat((site.Latitude || site.lat || '').replace(',', '.'));
            const lon = parseFloat((site.Longitude || site.lon || '').replace(',', '.'));

            if (isNaN(lat) || isNaN(lon)) return;

            // Save data for later translation
            loadedSites.push(site);

            // Clean Dot Icon
            const icon = L.divIcon({
                className: 'custom-div-icon', // Empty class to avoid default
                html: `<div class="dot-marker" style="width: 14px; height: 14px;"></div>`,
                iconSize: [14, 14],
                iconAnchor: [7, 7]
            });

            const marker = L.marker([lat, lon], { icon: icon });
            marker.siteData = site; // Attach data to marker
            marker.bindPopup("Loading...", { maxWidth: 220 });
            marker.bindTooltip(site.Name || 'Site', { direction: 'top', offset: [0, -10] });
            
            // Zoom Closer on click (Level 14)
            marker.on('click', function() {
                map.flyTo([lat, lon], 14, { duration: 1.5 });
            });

            markersLayer.addLayer(marker);
        });
        
        // Initialize Popups with default language
        updatePopups();
    }
});

</script>
</body>
</html>
