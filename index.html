<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dirty Business Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        #map { width: 100%; height: 100%; }
        
        /* Clean markers */
        .custom-marker { background: transparent !important; border: none !important; }
        
        /* Popup styling */
        .leaflet-popup-content-wrapper {
            border-radius: 0;
            box-shadow: none;
            border: 1px solid #000;
            padding: 0;
        }
        .leaflet-popup-content { margin: 12px 14px; font-family: -apple-system, sans-serif; }
        .leaflet-popup-tip { background: #fff; border: 1px solid #000; border-top: none; border-right: none; box-shadow: none; }
        .popup-name { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
        .popup-type { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: #666; margin-bottom: 4px; }
        .popup-place { font-size: 11px; color: #666; margin-bottom: 10px; }
        .popup-link { display: inline-block; font-size: 11px; color: #000; text-decoration: none; border-bottom: 1px solid #000; }
        .popup-link:hover { opacity: 0.6; }
        
        /* Controls */
        .leaflet-bottom.leaflet-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .leaflet-control-zoom { 
            border: none !important; 
            box-shadow: none !important; 
            margin-bottom: 5px !important;
        }
        .leaflet-control-zoom a { 
            background: #fff !important; 
            color: #000 !important; 
            border: 1px solid #000 !important; 
            width: 26px !important; 
            height: 26px !important; 
            line-height: 26px !important; 
            border-radius: 0 !important; 
        }
        .leaflet-control-scale { 
            margin-bottom: 10px !important; 
        }
        .leaflet-control-scale-line { 
            border: 1px solid #000 !important; 
            border-top: none !important; 
            background: #fff !important; 
            font-size: 9px !important; 
        }
        .leaflet-tooltip { 
            background: #fff; 
            border: 1px solid #000; 
            border-radius: 0; 
            box-shadow: none; 
            font-size: 11px; 
            padding: 4px 8px; 
        }
        
        /* Layer control */
        .leaflet-control-layers {
            border: 1px solid #000 !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }
        .leaflet-control-layers-expanded {
            padding: 8px 12px;
        }
        .leaflet-control-layers-base label,
        .leaflet-control-layers-overlays label {
            font-size: 11px;
            font-family: -apple-system, sans-serif;
        }
        .leaflet-control-layers-separator {
            border-top: 1px solid #ccc;
            margin: 6px 0;
        }
        
        /* Language switcher */
        .lang-switcher {
            position: absolute;
            top: 10px;
            left: 50px;
            z-index: 1000;
            display: flex;
            font-family: -apple-system, sans-serif;
            font-size: 11px;
            font-weight: 600;
        }
        .lang-btn {
            padding: 4px 8px;
            background: #fff;
            border: 1px solid #000;
            cursor: pointer;
            text-transform: uppercase;
        }
        .lang-btn:first-child { border-right: none; }
        .lang-btn.active { background: #000; color: #fff; }
        
        /* North arrow */
        .north-arrow { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            z-index: 1000; 
            background: #fff; 
            border: 1px solid #000; 
            padding: 4px; 
        }
        
        /* Legend */
        .legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            z-index: 1000;
            background: #fff;
            border: 1px solid #000;
            padding: 10px 14px;
            font-family: -apple-system, sans-serif;
            font-size: 11px;
            min-width: 130px;
        }
        .legend-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        .legend-symbol {
            width: 24px;
            display: flex;
            justify-content: center;
            margin-right: 8px;
        }
        .legend-label {
            color: #333;
        }
    </style>
</head>
<body>

<div id="map"></div>

<div class="north-arrow">
    <svg width="18" height="24" viewBox="0 0 18 24">
        <polygon points="9,0 16,20 9,15 2,20" fill="#000"/>
        <text x="9" y="23" text-anchor="middle" font-size="6" fill="#000">N</text>
    </svg>
</div>

<div class="lang-switcher">
    <div class="lang-btn active" data-lang="no">NO</div>
    <div class="lang-btn" data-lang="en">EN</div>
</div>

<div class="legend">
    <div class="legend-title" data-i18n="legend_title">TEGNFORKLARING</div>
    <div class="legend-item">
        <span class="legend-symbol">
            <svg width="14" height="14"><circle cx="7" cy="7" r="6" fill="white" stroke="black" stroke-width="1"/></svg>
        </span>
        <span class="legend-label" data-i18n="legend_deponi">Avfallsanlegg</span>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
// ============ TRANSLATIONS ============
const translations = {
    no: {
        legend_title: 'TEGNFORKLARING',
        legend_deponi: 'Avfallsanlegg',
        popup_details: 'VIS DETALJER →',
        layers_sat: 'Satellitt',
        layers_gray: 'Gråtone',
        layers_terrain: 'Terreng',
        layers_osm: 'OpenStreetMap',
        overlay_facilities: 'Anlegg',
        overlay_areas: 'Områder',
        overlay_contaminated: 'Forurenset grunn',
        overlay_municipalities: 'Kommunegrenser',
        overlay_counties: 'Fylkesgrenser',
        overlay_property: 'Eiendomsgrenser',
        overlay_gravel: 'Grus og Pukk',
        overlay_grid: 'Rutenett'
    },
    en: {
        legend_title: 'LEGEND',
        legend_deponi: 'Waste Facility',
        popup_details: 'VIEW DETAILS →',
        layers_sat: 'Satellite',
        layers_gray: 'Grayscale',
        layers_terrain: 'Terrain',
        layers_osm: 'OpenStreetMap',
        overlay_facilities: 'Facilities',
        overlay_areas: 'Areas',
        overlay_contaminated: 'Contaminated Sites',
        overlay_municipalities: 'Municipalities',
        overlay_counties: 'Counties',
        overlay_property: 'Property Lines',
        overlay_gravel: 'Gravel & Aggregates',
        overlay_grid: 'Grid'
    }
};

let currentLang = 'no';

function updateTranslations() {
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[currentLang][key]) {
            el.textContent = translations[currentLang][key];
        }
    });
}

// Language switcher
document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentLang = btn.getAttribute('data-lang');
        updateTranslations();
    });
});

// CONFIG
const DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS1KaVHKy2zLYGg4Urbhm2zjZkmuATNvIqJOxuECuU0wdickEExV-8G0vL1F7xG1WKn_ADmwwfSARan/pub?output=csv';
const CARGO_BASE_URL = 'https://dirtybusiness.cargo.site/';

// SVG Marker icons - white fill, black stroke
const MARKER_SVGS = {
    'circle': `<svg width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" fill="white" stroke="black" stroke-width="1.5"/></svg>`,
    'square': `<svg width="20" height="20" viewBox="0 0 20 20"><rect x="2" y="2" width="16" height="16" fill="white" stroke="black" stroke-width="1.5"/></svg>`,
    'triangle': `<svg width="20" height="20" viewBox="0 0 20 20"><polygon points="10,2 18,18 2,18" fill="white" stroke="black" stroke-width="1.5"/></svg>`,
    'diamond': `<svg width="20" height="20" viewBox="0 0 20 20"><polygon points="10,2 18,10 10,18 2,10" fill="white" stroke="black" stroke-width="1.5"/></svg>`
};

const MARKER_STYLES = {
    'Deponi': { shape: 'circle' },
    'Spesialdeponi': { shape: 'circle' },
    'Industrideponi': { shape: 'circle' },
    'Miljøpark': { shape: 'circle' },
    'Massemottak': { shape: 'circle' },
    'Massesenter': { shape: 'circle' },
    'Pukkverk': { shape: 'circle' },
    'Gjenvinning': { shape: 'circle' },
    'default': { shape: 'circle' }
};

// Initialize map - CENTERED ON OSLO
const map = L.map('map', { 
    zoomControl: false,
    center: [59.91, 10.75],  // Oslo coordinates
    zoom: 9
});

// ============ BASEMAP LAYERS ============

// Esri World Imagery (Current)
const esriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: '© Esri',
    maxZoom: 19
});

// Geonorge Grayscale - VERIFIED URL
const geonorgeGray = L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.topograatone', {
    layers: 'topo4graatone_WMS',
    format: 'image/png',
    transparent: false,
    attribution: '© Kartverket'
});

// Terrengmodell (DTM hillshade) - VERIFIED URL
const terrengmodell = L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.terrengmodell', {
    layers: 'relieff',
    format: 'image/png',
    transparent: false,
    attribution: '© Kartverket'
});

// OpenStreetMap
const osmStandard = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors',
    maxZoom: 19
});

// Set default basemap
esriImagery.addTo(map);

// ============ GRID/GRATICULE ============

// Create graticule layer
const graticuleLayer = L.layerGroup();

function createGraticule() {
    graticuleLayer.clearLayers();
    
    const bounds = map.getBounds();
    const zoom = map.getZoom();
    
    // Determine grid interval based on zoom
    let interval;
    if (zoom <= 6) interval = 2;
    else if (zoom <= 8) interval = 1;
    else if (zoom <= 10) interval = 0.5;
    else if (zoom <= 12) interval = 0.25;
    else interval = 0.1;
    
    const south = Math.floor(bounds.getSouth() / interval) * interval;
    const north = Math.ceil(bounds.getNorth() / interval) * interval;
    const west = Math.floor(bounds.getWest() / interval) * interval;
    const east = Math.ceil(bounds.getEast() / interval) * interval;
    
    const gridStyle = {
        color: 'rgba(0,0,0,0.3)',
        weight: 0.5,
        dashArray: '2,4'
    };
    
    // Latitude lines (horizontal)
    for (let lat = south; lat <= north; lat += interval) {
        const line = L.polyline([[lat, west - 1], [lat, east + 1]], gridStyle);
        graticuleLayer.addLayer(line);
        
        // Add label
        if (zoom >= 8) {
            const label = L.marker([lat, bounds.getWest() + 0.02], {
                icon: L.divIcon({
                    className: 'grid-label',
                    html: `<span style="font-size:9px;color:#333;background:rgba(255,255,255,0.7);padding:1px 3px;">${lat.toFixed(1)}°</span>`,
                    iconSize: [40, 12],
                    iconAnchor: [0, 6]
                })
            });
            graticuleLayer.addLayer(label);
        }
    }
    
    // Longitude lines (vertical)
    for (let lng = west; lng <= east; lng += interval) {
        const line = L.polyline([[south - 1, lng], [north + 1, lng]], gridStyle);
        graticuleLayer.addLayer(line);
        
        // Add label
        if (zoom >= 8) {
            const label = L.marker([bounds.getSouth() + 0.02, lng], {
                icon: L.divIcon({
                    className: 'grid-label',
                    html: `<span style="font-size:9px;color:#333;background:rgba(255,255,255,0.7);padding:1px 3px;">${lng.toFixed(1)}°</span>`,
                    iconSize: [40, 12],
                    iconAnchor: [20, 0]
                })
            });
            graticuleLayer.addLayer(label);
        }
    }
}

// Update graticule on map move
map.on('moveend', createGraticule);
map.on('zoomend', createGraticule);

// ============ WMS OVERLAY LAYERS ============

// Contaminated grounds (Forurenset grunn) - Miljødirektoratet
const forurensning = L.tileLayer.wms('https://kart.miljodirektoratet.no/arcgis/services/grunnforurensning2/MapServer/WMSServer', {
    layers: '0',
    format: 'image/png',
    transparent: true,
    attribution: '© Miljødirektoratet'
});

// Kommune boundaries - VERIFIED
const kommuner = L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.adm_enheter', {
    layers: 'Kommunegrense',
    format: 'image/png',
    transparent: true,
    attribution: '© Kartverket'
});

// Fylke boundaries - VERIFIED
const fylker = L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.adm_enheter', {
    layers: 'Fylkesgrense',
    format: 'image/png',
    transparent: true,
    attribution: '© Kartverket'
});

// Eiendomsgrenser (Property lines) - VERIFIED
const eiendomsgrenser = L.tileLayer.wms('https://openwms.statkart.no/skwms1/wms.matrikkel', {
    layers: 'Eiendomsgrense',
    format: 'image/png',
    transparent: true,
    attribution: '© Kartverket'
});

// Grus og Pukk - VERIFIED
const grusPukk = L.tileLayer.wms('https://geo.ngu.no/mapserver/GrusPukkWMS5', {
    layers: 'GrusPukkWMS5',
    format: 'image/png',
    transparent: true,
    attribution: '© NGU'
});

// ============ CONTROLS ============

// Zoom control
L.control.zoom({ position: 'bottomleft' }).addTo(map);

// Scale bar
L.control.scale({ 
    position: 'bottomleft', 
    metric: true, 
    imperial: false, 
    maxWidth: 120 
}).addTo(map);

// Layer groups
const markersLayer = L.layerGroup().addTo(map);
const polygonsLayer = L.layerGroup();

// Layer control
const baseMaps = {
    "Satellitt": esriImagery,
    "Gråtone": geonorgeGray,
    "Terreng": terrengmodell,
    "OpenStreetMap": osmStandard
};

const overlayMaps = {
    "Anlegg": markersLayer,
    "Områder": polygonsLayer,
    "Rutenett": graticuleLayer,
    "Forurenset grunn": forurensning,
    "Kommunegrenser": kommuner,
    "Fylkesgrenser": fylker,
    "Eiendomsgrenser": eiendomsgrenser,
    "Grus og Pukk": grusPukk
};

L.control.layers(baseMaps, overlayMaps, { 
    position: 'topright',
    collapsed: true 
}).addTo(map);

// Initialize graticule
createGraticule();

// ============ DATA LOADING ============

function createSlug(name) {
    return name.toLowerCase()
        .replace(/æ/g, 'ae').replace(/ø/g, 'o').replace(/å/g, 'a')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '');
}

Papa.parse(DATA_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
        console.log('CSV loaded, rows:', results.data.length);
        console.log('Headers:', results.meta.fields);
        console.log('First row:', results.data[0]);
        
        results.data.forEach((site, index) => {
            // Helper to parse numbers with comma or dot
            function parseCoord(val) {
                if (!val) return NaN;
                return parseFloat(String(val).replace(',', '.'));
            }
            
            const lat = parseCoord(site.Latitude || site.latitude || site.Lat || site.lat);
            const lon = parseCoord(site.Longitude || site.longitude || site.Lon || site.lon);
            
            if (isNaN(lat) || isNaN(lon)) {
                console.log('Invalid coordinates for row', index, site);
                return;
            }
            
            const type = site.Type || site.type || 'default';
            const name = site.Name || site.name || site.Navn || 'Unknown';
            const municipality = site.Municipality || site.municipality || site.Kommune || '';
            const county = site.County || site.county || site.Fylke || '';
            
            const style = MARKER_STYLES[type] || MARKER_STYLES['default'];
            const slug = createSlug(name);
            
            // Create SVG icon
            const icon = L.divIcon({
                className: 'custom-marker',
                html: MARKER_SVGS[style.shape],
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            const place = [municipality, county].filter(p => p).join(', ');
            
            const popupContent = `
                <div class="popup-name">${name}</div>
                <div class="popup-type">${type}</div>
                <div class="popup-place">${place}</div>
                <a href="${CARGO_BASE_URL}${slug}" target="_top" class="popup-link" data-i18n="popup_details">VIS DETALJER →</a>
            `;
            
            L.marker([lat, lon], { icon })
                .addTo(markersLayer)
                .bindPopup(popupContent, { closeButton: false })
                .bindTooltip(name, { direction: 'top', offset: [0, -10] });
        });
        
        console.log('Markers added:', markersLayer.getLayers().length);
    },
    error: function(error) {
        console.error('Error loading CSV:', error);
    }
});
</script>
</body>
</html>
