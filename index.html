<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dirty Business Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        #map { width: 100%; height: 100%; }
        
        /* Clean markers */
        .custom-marker { background: transparent !important; border: none !important; }
        
        /* Popup styling */
        .leaflet-popup-content-wrapper {
            border-radius: 0;
            box-shadow: none;
            border: 1px solid #000;
            padding: 0;
        }
        .leaflet-popup-content { margin: 12px 14px; font-family: -apple-system, sans-serif; }
        .leaflet-popup-tip { background: #fff; border: 1px solid #000; border-top: none; border-right: none; box-shadow: none; }
        .popup-name { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
        .popup-type { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: #666; margin-bottom: 4px; }
        .popup-place { font-size: 11px; color: #666; margin-bottom: 10px; }
        .popup-link { display: inline-block; font-size: 11px; color: #000; text-decoration: none; border-bottom: 1px solid #000; }
        .popup-link:hover { opacity: 0.6; }
        
        /* Controls */
        .leaflet-bottom.leaflet-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .leaflet-control-zoom { border: none !important; box-shadow: none !important; margin-bottom: 5px !important; }
        .leaflet-control-zoom a { background: #fff !important; color: #000 !important; border: 1px solid #000 !important; width: 26px !important; height: 26px !important; line-height: 26px !important; border-radius: 0 !important; }
        .leaflet-control-scale-line { border: 1px solid #000 !important; border-top: none !important; background: #fff !important; font-size: 9px !important; }
        .leaflet-tooltip { background: #fff; border: 1px solid #000; border-radius: 0; box-shadow: none; font-size: 11px; padding: 4px 8px; }
        
        /* Layer control */
        .leaflet-control-layers { border: 1px solid #000 !important; border-radius: 0 !important; box-shadow: none !important; }
        .leaflet-control-layers-expanded { padding: 8px 12px; }
        .leaflet-control-layers-base label, .leaflet-control-layers-overlays label { font-size: 11px; font-family: -apple-system, sans-serif; }
        .leaflet-control-layers-separator { border-top: 1px solid #ccc; margin: 6px 0; }
        
        /* North arrow */
        .north-arrow { position: absolute; top: 10px; left: 10px; z-index: 1000; background: #fff; border: 1px solid #000; padding: 4px; }
        
        /* Legend */
        .legend { position: absolute; bottom: 30px; right: 10px; z-index: 1000; background: #fff; border: 1px solid #000; padding: 10px 14px; font-family: -apple-system, sans-serif; font-size: 11px; min-width: 120px; }
        .legend-title { font-weight: 600; margin-bottom: 8px; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
        .legend-symbol { width: 20px; text-align: center; margin-right: 8px; font-size: 18px; color: #000; }
        .legend-label { color: #333; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="north-arrow">
    <svg width="18" height="24" viewBox="0 0 18 24">
        <polygon points="9,0 16,20 9,15 2,20" fill="#000"/>
        <text x="9" y="23" text-anchor="middle" font-size="6" fill="#000">N</text>
    </svg>
</div>

<div class="legend">
    <div class="legend-title">Anleggstype</div>
    <div class="legend-item"><span class="legend-symbol">●</span><span class="legend-label">Deponi</span></div>
    <div class="legend-item"><span class="legend-symbol">■</span><span class="legend-label">Massemottak</span></div>
    <div class="legend-item"><span class="legend-symbol">▲</span><span class="legend-label">Pukkverk</span></div>
    <div class="legend-item"><span class="legend-symbol">◆</span><span class="legend-label">Gjenvinning</span></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
// CONFIG
const DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS1KaVHKy2zLYGg4Urbhm2zjZkmuATNvIqJOxuECuU0wdickEExV-8G0vL1F7xG1WKn_ADmwwfSARan/pub?output=csv';
const CARGO_BASE_URL = 'https://dirtybusiness.cargo.site/';

const MARKER_STYLES = {
    'Deponi': { symbol: '●' }, 'Spesialdeponi': { symbol: '●' }, 'Industrideponi': { symbol: '●' }, 'Miljøpark': { symbol: '●' },
    'Massemottak': { symbol: '■' }, 'Massesenter': { symbol: '■' },
    'Pukkverk': { symbol: '▲' },
    'Gjenvinning': { symbol: '◆' },
    'default': { symbol: '●' }
};

// Initialize map
const map = L.map('map', { zoomControl: false, center: [60.0, 10.5], zoom: 8 });

// ============ BASEMAP LAYERS ============

// 1. Esri World Imagery (Standard / Current)
const esriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: '© Esri', maxZoom: 19
});

// 2. Geonorge Gråtone (Grey)
const geonorgeGray = L.tileLayer.wms('https://openwms.statkart.no/skwms1/wms.topograatone', {
    layers: 'topograatone',
    format: 'image/png',
    transparent: false,
    attribution: '© Kartverket'
});

// 3. Esri Wayback Layers - UPDATED IDs
// These IDs correspond to specific snapshots. If they fail in the future, check the Wayback app for new IDs.
const wayback2023 = L.tileLayer('https://wayback.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/MapServer/tile/44629/{z}/{y}/{x}', {
    attribution: '© Esri Wayback 2023', maxZoom: 19
});

const wayback2020 = L.tileLayer('https://wayback.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/MapServer/tile/9337/{z}/{y}/{x}', {
    attribution: '© Esri Wayback 2020', maxZoom: 19
});

const wayback2017 = L.tileLayer('https://wayback.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/MapServer/tile/5970/{z}/{y}/{x}', {
    attribution: '© Esri Wayback 2017', maxZoom: 19
});

const wayback2014 = L.tileLayer('https://wayback.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/MapServer/tile/2635/{z}/{y}/{x}', {
    attribution: '© Esri Wayback 2014', maxZoom: 19
});

// Set default
esriImagery.addTo(map);

// ============ WMS OVERLAY LAYERS ============

// Matrikkelkart (Property)
const matrikkelkart = L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.matrikkelkart', {
    layers: 'matrikkelkart',
    format: 'image/png',
    transparent: true,
    attribution: '© Kartverket'
});

// Kommuner (Municipalities) - FIXED
// Changed from 'Kommunegrense' to 'Kommuner' and updated URL
const kommuner = L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.adm_enheter', {
    layers: 'Kommuner',
    format: 'image/png',
    transparent: true,
    attribution: '© Kartverket'
});

// Fylker (Counties) - FIXED
// Changed from 'Fylkesgrense' to 'Fylker' and updated URL
const fylker = L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.adm_enheter', {
    layers: 'Fylker',
    format: 'image/png',
    transparent: true,
    attribution: '© Kartverket'
});

// ============ CONTROLS ============

L.control.zoom({ position: 'bottomleft' }).addTo(map);
L.control.scale({ position: 'bottomleft', metric: true, imperial: false, maxWidth: 120 }).addTo(map);

const markersLayer = L.layerGroup().addTo(map);
const polygonsLayer = L.layerGroup(); 

const baseMaps = {
    "Esri Satellite": esriImagery,
    "Esri 2023": wayback2023,
    "Esri 2020": wayback2020,
    "Esri 2017": wayback2017,
    "Esri 2014": wayback2014,
    "Gråtone": geonorgeGray
    // OSM Removed
};

const overlayMaps = {
    "Anlegg": markersLayer,
    "Områder": polygonsLayer,
    "Matrikkelkart": matrikkelkart,
    "Kommunegrenser": kommuner,
    "Fylkesgrenser": fylker
};

L.control.layers(baseMaps, overlayMaps, { position: 'topright', collapsed: true }).addTo(map);

// ============ DATA LOADING ============

function createSlug(name) {
    return name.toLowerCase()
        .replace(/æ/g, 'ae').replace(/ø/g, 'o').replace(/å/g, 'a')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '');
}

Papa.parse(DATA_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
        results.data.forEach((site) => {
            function parseCoord(val) {
                if (!val) return NaN;
                return parseFloat(String(val).replace(',', '.'));
            }
            const lat = parseCoord(site.Latitude || site.latitude || site.Lat || site.lat);
            const lon = parseCoord(site.Longitude || site.longitude || site.Lon || site.lon);
            
            if (isNaN(lat) || isNaN(lon)) return;
            
            const type = site.Type || site.type || site.TYPE || 'default';
            const name = site.Name || site.name || site.NAME || 'Unknown';
            const municipality = site.Municipality || site.municipality || site.Kommune || '';
            const county = site.County || site.county || site.Fylke || '';
            const style = MARKER_STYLES[type] || MARKER_STYLES['default'];
            const slug = createSlug(name);
            
            const icon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="color:#000;font-size:32px;line-height:1;text-shadow: 0 0 2px #fff;">${style.symbol}</div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });
            
            const place = [municipality, county].filter(p => p).join(', ');
            
            const popupContent = `
                <div class="popup-name">${name}</div>
                <div class="popup-type">${type}</div>
                <div class="popup-place">${place}</div>
                <a href="${CARGO_BASE_URL}${slug}" target="_top" class="popup-link">View details →</a>
            `;
            
            const marker = L.marker([lat, lon], { icon })
                .addTo(markersLayer)
                .bindPopup(popupContent, { closeButton: false })
                .bindTooltip(name, { direction: 'top', offset: [0, -16] });

            marker.on('click', function() {
                map.flyTo([lat, lon], 14, { animate: true, duration: 1.5 });
            });
        });
    }
});
</script>
</body>
</html>
