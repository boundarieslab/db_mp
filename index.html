<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dirty Business Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        #map { width: 100%; height: 100%; }
        
        /* Clean markers */
        .custom-marker { background: transparent !important; border: none !important; }
        
        /* Popup styling */
        .leaflet-popup-content-wrapper {
            border-radius: 0;
            box-shadow: none;
            border: 1px solid #000;
            padding: 0;
        }
        .leaflet-popup-content { margin: 12px 14px; font-family: -apple-system, sans-serif; }
        .leaflet-popup-tip { background: #fff; border: 1px solid #000; border-top: none; border-right: none; box-shadow: none; }
        .popup-name { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
        .popup-type { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: #666; margin-bottom: 4px; }
        .popup-place { font-size: 11px; color: #666; margin-bottom: 10px; }
        .popup-link { display: inline-block; font-size: 11px; color: #000; text-decoration: none; border-bottom: 1px solid #000; }
        .popup-link:hover { opacity: 0.6; }
        
        /* Controls */
        .leaflet-control-zoom { border: none !important; box-shadow: none !important; }
        .leaflet-control-zoom a { background: #fff !important; color: #000 !important; border: 1px solid #000 !important; width: 26px !important; height: 26px !important; line-height: 26px !important; border-radius: 0 !important; }
        .leaflet-control-scale-line { border: 1px solid #000 !important; border-top: none !important; background: #fff !important; font-size: 9px !important; }
        .leaflet-tooltip { background: #fff; border: 1px solid #000; border-radius: 0; box-shadow: none; font-size: 11px; padding: 4px 8px; }
        
        /* North arrow */
        .north-arrow { position: absolute; top: 80px; left: 10px; z-index: 1000; background: #fff; border: 1px solid #000; padding: 4px; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="north-arrow">
    <svg width="18" height="24" viewBox="0 0 18 24">
        <polygon points="9,0 16,20 9,15 2,20" fill="#000"/>
        <text x="9" y="23" text-anchor="middle" font-size="6" fill="#000">N</text>
    </svg>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
// CONFIG
const DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS1KaVHKy2zLYGg4Urbhm2zjZkmuATNvIqJOxuECuU0wdickEExV-8G0vL1F7xG1WKn_ADmwwfSARan/pub?output=csv';

// CHANGE THIS to your Cargo site URL
const CARGO_BASE_URL = 'https://dirtybusiness.cargo.site/';

const MARKER_STYLES = {
    'Deponi': { color: '#ff00ff', symbol: '●' },
    'Spesialdeponi': { color: '#ff00ff', symbol: '●' },
    'Industrideponi': { color: '#ff00ff', symbol: '●' },
    'Miljøpark': { color: '#ff00ff', symbol: '●' },
    'Massemottak': { color: '#00cccc', symbol: '■' },
    'Massesenter': { color: '#00cccc', symbol: '■' },
    'Pukkverk': { color: '#99cc00', symbol: '▲' },
    'Gjenvinning': { color: '#ff6600', symbol: '◆' },
    'default': { color: '#666', symbol: '●' }
};

// Initialize map
const map = L.map('map', { zoomControl: false }).setView([60.0, 10.5], 8);

// Zoom control
L.control.zoom({ position: 'bottomleft' }).addTo(map);

// Scale bar
L.control.scale({ position: 'bottomleft', metric: true, imperial: false, maxWidth: 120 }).addTo(map);

// Basemap - Esri satellite
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: '© Esri',
    maxZoom: 19
}).addTo(map);

// Create slug from name
function createSlug(name) {
    return name.toLowerCase()
        .replace(/æ/g, 'ae').replace(/ø/g, 'o').replace(/å/g, 'a')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '');
}

// Load data
Papa.parse(DATA_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
        results.data.forEach(site => {
            const lat = parseFloat(site.Latitude);
            const lon = parseFloat(site.Longitude);
            if (isNaN(lat) || isNaN(lon)) return;
            
            const style = MARKER_STYLES[site.Type] || MARKER_STYLES['default'];
            const slug = createSlug(site.Name || 'site');
            
            const icon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="color:${style.color};font-size:16px;line-height:1;">${style.symbol}</div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });
            
            const place = [site.Municipality, site.County].filter(p => p).join(', ');
            
            const popupContent = `
                <div class="popup-name">${site.Name || 'Unknown'}</div>
                <div class="popup-type">${site.Type || ''}</div>
                <div class="popup-place">${place}</div>
                <a href="${CARGO_BASE_URL}/${slug}" target="_top" class="popup-link">View details →</a>
            `;
            
            L.marker([lat, lon], { icon })
                .addTo(map)
                .bindPopup(popupContent, { closeButton: false })
                .bindTooltip(site.Name, { direction: 'top', offset: [0, -8] });
        });
    }
});
</script>
</body>
</html>
