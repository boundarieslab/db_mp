<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dirty Business Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        #map { width: 100%; height: 100%; }
        
        /* Clean markers */
        .custom-marker { background: transparent !important; border: none !important; }
        
        /* Popup styling */
        .leaflet-popup-content-wrapper {
            border-radius: 0;
            box-shadow: none;
            border: 1px solid #000;
            padding: 0;
        }
        .leaflet-popup-content { margin: 12px 14px; font-family: -apple-system, sans-serif; }
        .leaflet-popup-tip { background: #fff; border: 1px solid #000; border-top: none; border-right: none; box-shadow: none; }
        .popup-name { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
        .popup-type { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: #666; margin-bottom: 4px; }
        .popup-place { font-size: 11px; color: #666; margin-bottom: 10px; }
        .popup-link { display: inline-block; font-size: 11px; color: #000; text-decoration: none; border-bottom: 1px solid #000; }
        .popup-link:hover { opacity: 0.6; }
        
        /* Controls */
        .leaflet-bottom.leaflet-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .leaflet-control-zoom { 
            border: none !important; 
            box-shadow: none !important; 
            margin-bottom: 5px !important;
        }
        .leaflet-control-zoom a { 
            background: #fff !important; 
            color: #000 !important; 
            border: 1px solid #000 !important; 
            width: 26px !important; 
            height: 26px !important; 
            line-height: 26px !important; 
            border-radius: 0 !important; 
        }
        .leaflet-control-scale { 
            margin-bottom: 10px !important; 
        }
        .leaflet-control-scale-line { 
            border: 1px solid #000 !important; 
            border-top: none !important; 
            background: #fff !important; 
            font-size: 9px !important; 
        }
        .leaflet-tooltip { 
            background: #fff; 
            border: 1px solid #000; 
            border-radius: 0; 
            box-shadow: none; 
            font-size: 11px; 
            padding: 4px 8px; 
        }
        
        /* Layer control */
        .leaflet-control-layers {
            border: 1px solid #000 !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }
        .leaflet-control-layers-expanded {
            padding: 8px 12px;
        }
        .leaflet-control-layers-base label,
        .leaflet-control-layers-overlays label {
            font-size: 11px;
            font-family: -apple-system, sans-serif;
        }
        .leaflet-control-layers-separator {
            border-top: 1px solid #ccc;
            margin: 6px 0;
        }
        
        /* Language switcher */
        .lang-switcher {
            position: absolute;
            top: 10px;
            left: 50px;
            z-index: 1000;
            display: flex;
            font-family: -apple-system, sans-serif;
            font-size: 11px;
            font-weight: 600;
        }
        .lang-btn {
            padding: 4px 8px;
            background: #fff;
            border: 1px solid #000;
            cursor: pointer;
            text-transform: uppercase;
        }
        .lang-btn:first-child { border-right: none; }
        .lang-btn.active { background: #000; color: #fff; }
        
        /* North arrow */
        .north-arrow { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            z-index: 1000; 
            background: #fff; 
            border: 1px solid #000; 
            padding: 4px; 
        }
        
        /* Legend */
        .legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            z-index: 1000;
            background: #fff;
            border: 1px solid #000;
            padding: 10px 14px;
            font-family: -apple-system, sans-serif;
            font-size: 11px;
            min-width: 140px;
            max-width: 200px;
        }
        .legend-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        .legend-symbol {
            width: 24px;
            display: flex;
            justify-content: center;
            margin-right: 8px;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            margin-right: 8px;
        }
        .legend-label {
            color: #333;
        }
        .legend-section {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .legend-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        .legend-gradient {
            width: 100%;
            height: 12px;
            margin: 4px 0;
        }
        .legend-range {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: #666;
        }
        
        /* Hide overlay legends by default */
        .overlay-legend { display: none; }
        .overlay-legend.active { display: block; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="north-arrow">
    <svg width="18" height="24" viewBox="0 0 18 24">
        <polygon points="9,0 16,20 9,15 2,20" fill="#000"/>
        <text x="9" y="23" text-anchor="middle" font-size="6" fill="#000">N</text>
    </svg>
</div>

<div class="lang-switcher">
    <div class="lang-btn active" data-lang="no">NO</div>
    <div class="lang-btn" data-lang="en">EN</div>
</div>

<div class="legend">
    <!-- Main legend - always visible -->
    <div class="legend-section" id="legend-main">
        <div class="legend-title">TEGNFORKLARING</div>
        <div class="legend-item">
            <span class="legend-symbol">
                <svg width="12" height="12"><circle cx="6" cy="6" r="5" fill="white" stroke="black" stroke-width="1"/></svg>
            </span>
            <span class="legend-label">Avfallsanlegg</span>
        </div>
    </div>
    
    <!-- DTM Legend -->
    <div class="legend-section overlay-legend" id="legend-dtm">
        <div class="legend-title">TERRENG (DTM)</div>
        <div class="legend-gradient" style="background: linear-gradient(to right, #1a472a, #5a8f5a, #cddc39, #ff9800, #b71c1c);"></div>
        <div class="legend-range">
            <span>Lavt</span>
            <span>Høyt</span>
        </div>
    </div>
    
    <!-- Contaminated ground legend -->
    <div class="legend-section overlay-legend" id="legend-contaminated">
        <div class="legend-title">FORURENSET GRUNN</div>
        <div class="legend-item">
            <span class="legend-color" style="background: #ff0000;"></span>
            <span class="legend-label">Påvist forurensning</span>
        </div>
        <div class="legend-item">
            <span class="legend-color" style="background: #ffaa00;"></span>
            <span class="legend-label">Mistanke</span>
        </div>
    </div>
    
    <!-- Grus og Pukk legend -->
    <div class="legend-section overlay-legend" id="legend-gravel">
        <div class="legend-title">GRUS OG PUKK</div>
        <div class="legend-item">
            <span class="legend-color" style="background: #d4a574;"></span>
            <span class="legend-label">Forekomst</span>
        </div>
    </div>
    
    <!-- Property lines legend -->
    <div class="legend-section overlay-legend" id="legend-property">
        <div class="legend-title">EIENDOMSGRENSER</div>
        <div class="legend-item">
            <span class="legend-symbol">
                <svg width="20" height="12"><line x1="0" y1="6" x2="20" y2="6" stroke="#333" stroke-width="1"/></svg>
            </span>
            <span class="legend-label">Grense</span>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
// CONFIG
const DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS1KaVHKy2zLYGg4Urbhm2zjZkmuATNvIqJOxuECuU0wdickEExV-8G0vL1F7xG1WKn_ADmwwfSARan/pub?output=csv';
const CARGO_BASE_URL = 'https://dirtybusiness.cargo.site/';

// Language
let currentLang = 'no';

document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentLang = btn.getAttribute('data-lang');
    });
});

// SVG Marker icon
const MARKER_SVG = `<svg width="14" height="14" viewBox="0 0 14 14"><circle cx="7" cy="7" r="5.5" fill="white" stroke="black" stroke-width="1"/></svg>`;

// Initialize map - CENTERED ON OSLO
const map = L.map('map', { 
    zoomControl: false,
    center: [59.91, 10.75],
    zoom: 9
});

// ============ BASEMAP LAYERS ============

// Esri World Imagery (Current/Recent)
const esriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: '© Esri',
    maxZoom: 19
});

// Esri Wayback 2014 (February 20, 2014 - release 10)
const wayback2014 = L.tileLayer('https://wayback.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/MapServer/tile/10/{z}/{y}/{x}', {
    attribution: '© Esri Wayback 2014',
    maxZoom: 19
});

// Kartverket Grayscale - WMTS tile cache (most reliable)
const grayTiles = L.tileLayer('https://cache.kartverket.no/v1/wmts/1.0.0/topo4graatone/default/webmercator/{z}/{y}/{x}.png', {
    attribution: '© Kartverket',
    maxZoom: 18
});

// Set default basemap
esriImagery.addTo(map);

// ============ OVERLAY LAYERS ============

// DTM10 Terrengmodell - hillshade
const dtm10 = L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.hoyde-dtm-nhm-25833', {
    layers: 'nhm_dtm_topo_25833',
    format: 'image/png',
    transparent: true,
    opacity: 0.7,
    attribution: '© Kartverket'
});

// Contaminated grounds - Miljødirektoratet
const forurensning = L.tileLayer.wms('https://kart.miljodirektoratet.no/arcgis/services/grunnforurensning/MapServer/WMSServer', {
    layers: '0,1,2',
    format: 'image/png',
    transparent: true,
    attribution: '© Miljødirektoratet'
});

// Grus og Pukk - NGU
const grusPukk = L.tileLayer.wms('https://geo.ngu.no/mapserver/GrusPukkWMS5', {
    layers: 'GrusPukkWMS5',
    format: 'image/png',
    transparent: true,
    attribution: '© NGU'
});

// Property lines - Matrikkelkart teiggrense
const eiendomsgrenser = L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.matrikkelkart', {
    layers: 'teiggrense',
    format: 'image/png',
    transparent: true,
    attribution: '© Kartverket'
});

// Apply multiply blend mode when layers are added
function applyMultiplyBlend(layer) {
    if (layer._container) {
        layer._container.style.mixBlendMode = 'multiply';
    }
}

dtm10.on('load', function() { applyMultiplyBlend(this); });
forurensning.on('load', function() { applyMultiplyBlend(this); });
grusPukk.on('load', function() { applyMultiplyBlend(this); });
eiendomsgrenser.on('load', function() { applyMultiplyBlend(this); });

// ============ CONTROLS ============

L.control.zoom({ position: 'bottomleft' }).addTo(map);

L.control.scale({ 
    position: 'bottomleft', 
    metric: true, 
    imperial: false, 
    maxWidth: 120 
}).addTo(map);

// Layer groups
const markersLayer = L.layerGroup().addTo(map);

// Layer control
const baseMaps = {
    "Satellitt": esriImagery,
    "Satellitt 2014": wayback2014,
    "Gråtone": grayTiles
};

const overlayMaps = {
    "Anlegg": markersLayer,
    "Terreng (DTM)": dtm10,
    "Forurenset grunn": forurensning,
    "Grus og Pukk": grusPukk,
    "Eiendomsgrenser": eiendomsgrenser
};

L.control.layers(baseMaps, overlayMaps, { 
    position: 'topright',
    collapsed: true 
}).addTo(map);

// ============ LEGEND TOGGLE ============

const legendMap = {
    'Terreng (DTM)': 'legend-dtm',
    'Forurenset grunn': 'legend-contaminated',
    'Grus og Pukk': 'legend-gravel',
    'Eiendomsgrenser': 'legend-property'
};

map.on('overlayadd', function(e) {
    const legendId = legendMap[e.name];
    if (legendId) {
        document.getElementById(legendId).classList.add('active');
    }
});

map.on('overlayremove', function(e) {
    const legendId = legendMap[e.name];
    if (legendId) {
        document.getElementById(legendId).classList.remove('active');
    }
});

// ============ DATA LOADING ============

function createSlug(name) {
    return name.toLowerCase()
        .replace(/æ/g, 'ae').replace(/ø/g, 'o').replace(/å/g, 'a')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '');
}

Papa.parse(DATA_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
        console.log('CSV loaded, rows:', results.data.length);
        
        results.data.forEach((site, index) => {
            function parseCoord(val) {
                if (!val) return NaN;
                return parseFloat(String(val).replace(',', '.'));
            }
            
            const lat = parseCoord(site.Latitude || site.latitude || site.Lat || site.lat);
            const lon = parseCoord(site.Longitude || site.longitude || site.Lon || site.lon);
            
            if (isNaN(lat) || isNaN(lon)) {
                console.log('Invalid coordinates for row', index, site);
                return;
            }
            
            const type = site.Type || site.type || 'default';
            const name = site.Name || site.name || site.Navn || 'Unknown';
            const municipality = site.Municipality || site.municipality || site.Kommune || '';
            const county = site.County || site.county || site.Fylke || '';
            const slug = createSlug(name);
            
            const icon = L.divIcon({
                className: 'custom-marker',
                html: MARKER_SVG,
                iconSize: [14, 14],
                iconAnchor: [7, 7]
            });
            
            const place = [municipality, county].filter(p => p).join(', ');
            
            const popupContent = `
                <div class="popup-name">${name}</div>
                <div class="popup-type">${type}</div>
                <div class="popup-place">${place}</div>
                <a href="${CARGO_BASE_URL}${slug}" target="_top" class="popup-link">VIS DETALJER →</a>
            `;
            
            const marker = L.marker([lat, lon], { icon })
                .addTo(markersLayer)
                .bindPopup(popupContent, { closeButton: false })
                .bindTooltip(name, { direction: 'top', offset: [0, -7] });
            
            // CLICK TO ZOOM - zoom to point on click
            marker.on('click', function(e) {
                map.setView([lat, lon], 14, {
                    animate: true,
                    duration: 0.5
                });
            });
        });
        
        console.log('Markers added:', markersLayer.getLayers().length);
    },
    error: function(error) {
        console.error('Error loading CSV:', error);
    }
});
</script>
</body>
</html>
